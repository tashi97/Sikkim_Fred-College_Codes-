SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[P_INS_USER]
(
	@USER_ID		BIGINT = NULL,
	@USER_NAME		NVARCHAR(50) = NULL,
	@PASSWORD		NVARCHAR(MAX) = NULL,
	@IS_LOGGED_IN	BIT = NULL,
	@TYPE			TINYINT = NULL,
	@IS_SUPER       BIT=Null,
	@IS_ADMIN		BIT = NULL,
	@IS_RCO         BIT=Null,
	@IS_DDO         BIT=Null,
	@DEPT			BIGINT = NULL,
	@ddocode        NVARCHAR(6) = NULL,
	@RETURN_ID		BIGINT = 0 OUTPUT
)

AS

BEGIN TRY
	
	IF @USER_ID IS NOT NULL
		BEGIN
			UPDATE TBL_USER
			SET
				-- [USER_ID] = ? -- this column value is auto-generated,
				[USER_NAME] = ISNULL(@USER_NAME,[USER_NAME]),
				[PASSWORD] = ISNULL(@PASSWORD,[PASSWORD]),
				IS_LOGGED_IN = ISNULL(@IS_LOGGED_IN,IS_LOGGED_IN),
				[TYPE] = ISNULL(@TYPE,[TYPE]),
				IS_SUPER =@IS_SUPER,
				IS_ADMIN = @IS_ADMIN,
				IS_RCO =@IS_RCO,
				IS_DDO=@IS_DDO,
				DEPT_ID = @DEPT,
				ddocode=@ddocode 
			WHERE
				[USER_ID] = @USER_ID
		END
	--------------
	ELSE
		BEGIN
			INSERT INTO TBL_USER
			(
				-- [USER_ID] -- this column value is auto-generated,
				[USER_NAME],
				[PASSWORD],
				IS_LOGGED_IN,
				LAST_LOGIN_DATE,
				[ACTIVE],
				CREATE_DATE,
				LAST_SCH_NO,
				STEP,
				[TYPE],
				IS_SUPER,
				IS_ADMIN,
				IS_RCO,
				IS_DDO,
				DEPT_ID,
				ddocode
			)
			VALUES
			(
				@USER_NAME/* [USER_NAME]	*/,
				@PASSWORD/* [PASSWORD]	*/,
				@IS_LOGGED_IN/* IS_LOGGED_IN	*/,
				GETDATE()/* LAST_LOGIN_DATE	*/,
				0/* [ACTIVE]	*/,
				GETDATE()/* CREATE_DATE	*/,
				020001/* LAST_SCH_NO	*/,
				0/* STEP	*/,
				@TYPE/* [TYPE]	*/,
				@IS_SUPER,
				@IS_ADMIN,
				@IS_RCO,
				@IS_DDO,
				@DEPT,
				@ddocode 
			)
			
			
		--	SET @TABLEONEPK =SCOPE_IDENTITY()
		--	IF @DEPT =null OR @DEPT='ALL DEMAND' or @DEPT=0		
		--BEGIN				
		--	 --SET @DEPT='1,2,3,4,5,,6,7,8,9,101,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,46,91,92,94,99'
		--	INSERT INTO TBL_USER_TO_DEMAND_MAPPING (USER_ID,DEMAND_ID)
		--	VALUES(@TABLEONEPK,('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,46,91,92,94,99'));
		--	END
		--	ELSE
		--	BEGIN
		--	INSERT INTO TBL_USER_TO_DEMAND_MAPPING (USER_ID,DEMAND_ID)
		--	VALUES(@TABLEONEPK,@DEPT)
					
		--END
		
END
	--THIS PORTION IS WHERE THE DATA 1,2,3,4,5,6,7,8,9,10-------- IS NOT BEING INSERTED.	
	
		SET NOCOUNT ON
		DECLARE @TABLEONEPK INT
		SET @TABLEONEPK =SCOPE_IDENTITY()
		SET @RETURN_ID = @TABLEONEPK
	IF @DEPT != 0		
		BEGIN				
			 --SET @DEPT='1,2,3,4,5,,6,7,8,9,101,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,46,91,92,94,99'
			INSERT INTO TBL_USER_TO_DEMAND_MAPPING (USER_ID,DEMAND_ID)
			VALUES(@TABLEONEPK,@DEPT)
			END
			ELSE
			BEGIN
			
			INSERT INTO TBL_USER_TO_DEMAND_MAPPING (USER_ID,DEMAND_ID)
			VALUES(@TABLEONEPK,('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,46,91,92,94,99'));
			END
	 
END TRY		
		
BEGIN CATCH
	DECLARE @ERR  VARCHAR(1000)
	SELECT @ERR=ERROR_MESSAGE()
	IF	ERROR_SEVERITY () > 12
		BEGIN
			RAISERROR (@ERR, 16, 20)
		END
		--
		ELSE
		--
		BEGIN
			RAISERROR (@ERR, 12, 2)
		END
END CATCH

GO